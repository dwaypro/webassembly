<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>title</title>
  </head>
  <body>
    <h1>Web Assembly</h1>
    <script>

      // initialize wasm with custom memory (array buffer)
      // 20 pages: 20 * 64kb(128kb);
      const wasmMemory = new WebAssembly.Memory({ initial: 2});
      console.log("TCL: wasmMemory", wasmMemory)
      
      // read a string out of Web Assembly memory
      const readMemStr = (offset, length) => {        
        console.log("TCL: wasmMemory.buffer", wasmMemory.buffer)
        const strBuffer = new Uint8Array(wasmMemory.buffer, offset, length);
        // const strBuffer = new Uint8Array(wasm.instance.exports.memory.buffer, offset, length);
        const str = new TextDecoder().decode(strBuffer);
        console.log('str', str);

        //Notify and make use of new string
        window.dispatchEvent( new CustomEvent('wasmValue', {detail: str}))
      }

      window.addEventListener('wasmValue', str =>{
        console.log("TCL: str", str);        
      })
      // imports
      const imports = {
        env:{
          numLog: console.log,
          strLog: readMemStr,
          memory: wasmMemory
        }
      }

        WebAssembly.instantiateStreaming(fetch('/program.wasm'), imports).then(wasm =>{
            console.log('wasm ready', wasm);
            wasm.instance.exports.getDoubleNumber(33);                       
            window.wasm = wasm;
          })
    </script>
  </body>
</html>